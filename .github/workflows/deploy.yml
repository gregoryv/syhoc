name: Build and Deploy versioned site (Pages)

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # access tags

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install stp
        run: |
          go install github.com/gregoryv/stp@484f7c5
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Determine output directory
        id: vars
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            folder="${GITHUB_REF_NAME}"
          else
            folder="head"
          fi
          echo "folder=$folder" >> $GITHUB_OUTPUT

      - name: Generate versioned HTML
        run: |
          mkdir -p site/${{ steps.vars.outputs.folder }}
          stp -i spec.txt -o site/${{ steps.vars.outputs.folder }}/index.html

      - name: Generate index.html listing all versions
        run: |
          echo "<!DOCTYPE html><html><head><meta charset='utf-8'><title>Available versions</title></head><body>" > site/index.html
          echo "<h1>Available versions</h1><ul>" >> site/index.html

          # Rebuild list from previous deployment (if available)
          echo "<!-- previous versions will appear after first deploy -->" >> site/index.html

          echo "<li><a href='${{ steps.vars.outputs.folder }}/'>${{ steps.vars.outputs.folder }}</a></li>" >> site/index.html
          echo "</ul></body></html>" >> site/index.html

      - name: Disable Jekyll
        run: touch site/.nojekyll

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

